<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>EBEXJS • Todo App</title>
        <style>
            * {
                box-sizing: border-box;
            }

            :root {
                color-scheme: dark;
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    sans-serif;
                background-color: #0a0a0a;
                color: #e5e5e5;
                --accent: #20a6f7;
                --surface: #141414;
                --border: rgba(255, 255, 255, 0.08);
                --muted: #707070;
            }

            body {
                margin: 0;
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: flex-start;
                padding: 5vh 1rem;
                background: #0a0a0a;
            }

            .app {
                width: min(560px, 100%);
                padding: 0;
            }

            h1 {
                margin: 0 0 2.5rem 0;
                font-size: clamp(1.85rem, 3vw, 2.2rem);
                letter-spacing: -0.02em;
                font-weight: 500;
                color: #ffffff;
            }

            form {
                display: flex;
                gap: 0.5rem;
                margin-bottom: 2rem;
                align-items: stretch;
            }

            input[type="text"] {
                flex: 1 1 auto;
                padding: 0.75rem 1rem;
                border-radius: 10px;
                border: 1px solid var(--border);
                background: var(--surface);
                color: #ffffff;
                font-size: 0.95rem;
                transition:
                    border-color 180ms ease,
                    background-color 180ms ease;
            }

            input[type="text"]::placeholder {
                color: var(--muted);
            }

            input[type="text"]:focus {
                border-color: rgba(32, 166, 247, 0.5);
                outline: none;
                background: rgba(20, 20, 20, 0.8);
            }

            button {
                border: none;
                border-radius: 10px;
                padding: 0.75rem 1.25rem;
                font-size: 0.95rem;
                font-weight: 500;
                cursor: pointer;
                background: var(--accent);
                color: #0a0a0a;
                transition:
                    background-color 160ms ease,
                    opacity 160ms ease;
            }

            button:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: 2px;
            }

            button:disabled {
                opacity: 0.35;
                cursor: not-allowed;
            }

            button:hover:not(:disabled) {
                background: #3db4ff;
            }

            button:active:not(:disabled) {
                background: #1a9ae8;
            }

            .toolbar {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 1.5rem;
            }

            .filters {
                display: flex;
                align-items: center;
                gap: 0.25rem;
            }

            .filter-btn {
                background: transparent;
                color: var(--muted);
                padding: 0.5rem 1rem;
                font-weight: 500;
                transition: color 160ms ease;
            }

            .filter-btn:hover:not(:disabled) {
                color: #e5e5e5;
                background: transparent;
            }

            .filter-btn.active {
                background: transparent;
                color: #ffffff;
            }

            .summary {
                font-size: 0.9rem;
                color: var(--muted);
                font-weight: 400;
            }

            .ghost-btn {
                background: transparent;
                color: var(--muted);
                border: 1px solid var(--border);
                padding: 0.5rem 1rem;
                font-weight: 500;
            }

            .ghost-btn:hover:not(:disabled) {
                color: #e5e5e5;
                background: rgba(255, 255, 255, 0.03);
            }

            .ghost-btn:disabled {
                border-color: rgba(255, 255, 255, 0.04);
                color: rgba(112, 112, 112, 0.4);
            }

            ul {
                list-style: none;
                padding: 0;
                margin: 0;
                display: grid;
                gap: 0.5rem;
            }

            li {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.85rem 1rem;
                border-radius: 10px;
                background: var(--surface);
                border: 1px solid var(--border);
                transition:
                    border-color 160ms ease,
                    background-color 160ms ease;
            }

            li:hover {
                border-color: rgba(255, 255, 255, 0.12);
                background: rgba(20, 20, 20, 0.9);
            }

            input[type="checkbox"] {
                width: 1rem;
                height: 1rem;
                accent-color: var(--accent);
                cursor: pointer;
                flex-shrink: 0;
            }

            li.completed .todo-text {
                text-decoration: line-through;
                color: var(--muted);
            }

            .todo-text {
                flex: 1 1 auto;
                font-size: 0.95rem;
                color: #e5e5e5;
            }

            li button {
                background: transparent;
                color: var(--muted);
                padding: 0.4rem 0.85rem;
                font-size: 0.85rem;
                border: 1px solid transparent;
                opacity: 0;
                transition:
                    opacity 160ms ease,
                    color 160ms ease,
                    border-color 160ms ease;
            }

            li:hover button {
                opacity: 1;
            }

            li button:hover {
                color: #ff5555;
                border-color: rgba(255, 85, 85, 0.25);
                background: rgba(255, 85, 85, 0.08);
            }

            .empty-state {
                margin: 3rem 0;
                text-align: center;
                color: var(--muted);
                font-size: 0.95rem;
            }

            @media (max-width: 600px) {
                .app {
                    padding: 0;
                }

                form {
                    flex-direction: column;
                    align-items: stretch;
                }

                button,
                input[type="text"] {
                    width: 100%;
                }

                .toolbar {
                    flex-direction: column;
                    align-items: stretch;
                    gap: 1rem;
                }

                .filters {
                    justify-content: flex-start;
                }

                .summary {
                    text-align: left;
                }

                .ghost-btn {
                    width: 100%;
                }

                li button {
                    opacity: 1;
                }
            }
        </style>
    </head>
    <body>
        <main class="app">
            <h1>Tasks</h1>
            <form id="todo-form" autocomplete="off">
                <input
                    id="todo-input"
                    type="text"
                    placeholder="What needs to be done?"
                    aria-label="Add a new todo"
                />
                <button type="submit">Add</button>
            </form>

            <section class="toolbar">
                <div class="filters" role="group" aria-label="Todo filters">
                    <button class="filter-btn active" data-filter="all">
                        All
                    </button>
                    <button class="filter-btn" data-filter="active">
                        Active
                    </button>
                    <button class="filter-btn" data-filter="completed">
                        Completed
                    </button>
                </div>
                <div class="summary" id="summary">0 items · 0 completed</div>
                <button id="clear-completed" class="ghost-btn" type="button">
                    Clear completed
                </button>
            </section>

            <ul id="todo-list" aria-live="polite"></ul>
            <div class="empty-state" id="empty-state">No tasks yet.</div>
        </main>

        <script type="module">
            import { EBEXJS } from "../packages/ebexjs.mjs";

            const bus = new EBEXJS();

            const Events = Object.freeze({
                ADD_TODO: "ADD_TODO",
                TOGGLE_TODO: "TOGGLE_TODO",
                DELETE_TODO: "DELETE_TODO",
                CLEAR_COMPLETED: "CLEAR_COMPLETED",
                FILTER_CHANGED: "FILTER_CHANGED",
                STATE_UPDATED: "STATE_UPDATED",
            });

            const store = {
                todos: [],
                filter: "all",
                nextId: 1,
            };

            const summaryEl = document.querySelector("#summary");
            const form = document.querySelector("#todo-form");
            const input = document.querySelector("#todo-input");
            const todoList = document.querySelector("#todo-list");
            const emptyStateEl = document.querySelector("#empty-state");
            const clearCompletedBtn =
                document.querySelector("#clear-completed");
            const filterButtons = Array.from(
                document.querySelectorAll(".filter-btn[data-filter]"),
            );

            const createSnapshot = () => ({
                todos: store.todos.map((todo) => ({ ...todo })),
                filter: store.filter,
                total: store.todos.length,
                completed: store.todos.filter((todo) => todo.completed).length,
            });

            const broadcastState = async () => {
                await bus.emit(Events.STATE_UPDATED, createSnapshot());
            };

            const withGuard = (handler) => async (payload) => {
                try {
                    await handler(payload ?? {});
                } catch (error) {
                    console.error("TodoApp handler error", error);
                }
            };

            bus.on({
                event: Events.ADD_TODO,
                priority: 100,
                needAwait: true,
                callback: withGuard(async ({ text }) => {
                    const normalized = (text ?? "").trim();
                    if (normalized.length === 0) {
                        return;
                    }
                    store.todos.push({
                        id: store.nextId++,
                        text: normalized,
                        completed: false,
                        createdAt: Date.now(),
                    });
                    await broadcastState();
                }),
            });

            bus.on({
                event: Events.TOGGLE_TODO,
                priority: 100,
                needAwait: true,
                callback: withGuard(async ({ id }) => {
                    const todo = store.todos.find(
                        (item) => item.id === Number(id),
                    );
                    if (!todo) {
                        return;
                    }
                    todo.completed = !todo.completed;
                    await broadcastState();
                }),
            });

            bus.on({
                event: Events.DELETE_TODO,
                priority: 100,
                needAwait: true,
                callback: withGuard(async ({ id }) => {
                    const numericId = Number(id);
                    store.todos = store.todos.filter(
                        (todo) => todo.id !== numericId,
                    );
                    await broadcastState();
                }),
            });

            bus.on({
                event: Events.CLEAR_COMPLETED,
                priority: 100,
                needAwait: true,
                callback: withGuard(async () => {
                    store.todos = store.todos.filter((todo) => !todo.completed);
                    await broadcastState();
                }),
            });

            bus.on({
                event: Events.FILTER_CHANGED,
                priority: 100,
                needAwait: true,
                callback: withGuard(async ({ filter }) => {
                    if (!filter) {
                        return;
                    }
                    store.filter = filter;
                    await broadcastState();
                }),
            });

            bus.on({
                event: Events.STATE_UPDATED,
                priority: 10,
                needAwait: false,
                callback: ({ todos, filter, total, completed }) => {
                    const filters = {
                        all: () => true,
                        active: (todo) => !todo.completed,
                        completed: (todo) => todo.completed,
                    };
                    const applyFilter = filters[filter] ?? filters.all;
                    const visibleTodos = todos.filter(applyFilter);

                    todoList.innerHTML = "";
                    if (visibleTodos.length === 0) {
                        emptyStateEl.hidden = false;
                    } else {
                        emptyStateEl.hidden = true;
                        const fragment = document.createDocumentFragment();
                        for (const todo of visibleTodos) {
                            const item = document.createElement("li");
                            item.classList.toggle("completed", todo.completed);
                            const checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.checked = todo.completed;
                            checkbox.dataset.id = String(todo.id);
                            checkbox.setAttribute(
                                "aria-label",
                                `Toggle ${todo.text}`,
                            );

                            const text = document.createElement("span");
                            text.className = "todo-text";
                            text.textContent = todo.text;

                            const removeBtn = document.createElement("button");
                            removeBtn.type = "button";
                            removeBtn.textContent = "Remove";
                            removeBtn.dataset.id = String(todo.id);
                            removeBtn.className = "filter-btn";

                            item.append(checkbox, text, removeBtn);
                            fragment.append(item);
                        }
                        todoList.append(fragment);
                    }

                    summaryEl.textContent = `${total} item${
                        total === 1 ? "" : "s"
                    } · ${completed} completed`;

                    for (const button of filterButtons) {
                        const isActive = button.dataset.filter === filter;
                        button.classList.toggle("active", isActive);
                        button.setAttribute(
                            "aria-pressed",
                            isActive ? "true" : "false",
                        );
                    }

                    clearCompletedBtn.disabled = completed === 0;
                },
            });

            bus.use({
                processing: ({ event }) => {
                    if (event === Events.STATE_UPDATED) {
                        return;
                    }
                    console.info(`[bus] processing ${event}`);
                },
            });

            form.addEventListener("submit", (event) => {
                event.preventDefault();
                const text = input.value;
                input.value = "";
                void bus.emit(Events.ADD_TODO, { text });
            });

            input.addEventListener("keydown", (event) => {
                if (event.key === "Escape") {
                    input.value = "";
                }
            });

            todoList.addEventListener("click", (event) => {
                const button = event.target.closest("button[data-id]");
                if (!button) {
                    return;
                }
                const { id } = button.dataset;
                void bus.emit(Events.DELETE_TODO, { id });
            });

            todoList.addEventListener("change", (event) => {
                const checkbox = event.target.closest("input[type='checkbox']");
                if (!checkbox) {
                    return;
                }
                const { id } = checkbox.dataset;
                void bus.emit(Events.TOGGLE_TODO, { id });
            });

            clearCompletedBtn.addEventListener("click", () => {
                void bus.emit(Events.CLEAR_COMPLETED);
            });

            for (const button of filterButtons) {
                button.addEventListener("click", () => {
                    const { filter } = button.dataset;
                    void bus.emit(Events.FILTER_CHANGED, { filter });
                });
            }

            void bus.emit(Events.STATE_UPDATED, createSnapshot());
        </script>
    </body>
</html>
